---
#########################################################
## OpenBao install action                              ##
#########################################################

#########################################################
## Pre-installation uninstall                          ##
#########################################################

# Run uninstall if uninstall is set
- name: Run uninstall playbook if set
  ansible.builtin.include_tasks: uninstall.yml
  when: openbao_container_uninstall | default(false)

#########################################################
## Installation on podman                              ##
#########################################################

- name: Install {{ role_container_name }} container on podman...
  when: openbao_container_platform == "podman"
  block:
    # Gather installed packages
    - name: Gather installed packages
      ansible.builtin.package_facts:
        manager: auto

    # Check if podman is detected
    - name: Gather information (podman)...
      ansible.builtin.assert:
        that: '"podman" in ansible_facts.packages'
        fail_msg: Podman is not installed. Please install Podman first. Cannot continue...

    #####################################################
    ## Volume configuration                            ##
    #####################################################

    # Create volumes
    - name: Create configuration folders...
      ansible.builtin.include_role:
        name: podman
      vars:
        action_type: create_volumes
        container_volumes: "{{ openbao_container_volumes }}"
        volume_mode: "0777"

    #####################################################
    ## OpenBao SSL certificate                         ##
    #####################################################

    # Create temp folder for SSL certificate
    - name: Create temporary folder...
      ansible.builtin.file:
        path: /tmp/vault/certs
        state: directory
        mode: "0700"

    # Create SSL certificate
    - name: Create SSL certificate for OpenBao...
      ansible.builtin.include_tasks:
        file: create_ssl_certificate.yml
      vars:
        destination_folder: /tmp/vault/certs

    # Copy SSL certificate to container
    - name: Copy SSL certificate to container volume...
      ansible.builtin.include_role:
        name: podman
      vars:
        action_type: copy_to_volume
        volume_source_folder: /tmp/vault/certs/
        volume_destination_folder: /vault/config
        volume_mode: "0777"

    # Delete temp folder
    - name: Delete temporary folder...
      ansible.builtin.file:
        path: /tmp/vault/certs
        state: absent

    #####################################################
    ## Vault configuration                             ##
    #####################################################

    # Create temp folder for configuration file
    - name: Create temporary folder...
      ansible.builtin.file:
        path: /tmp/vault
        state: directory
        mode: "0700"

    # Create configuration file
    - name: Create Vault configuration file...
      ansible.builtin.template:
        src: ./templates/vault.podman_config.hcl.j2
        dest: /tmp/vault/vault.hcl

    # Copy configuration file to container
    - name: Copy configuration file to container...
      ansible.builtin.include_role:
        name: podman
      vars:
        action_type: copy_to_volume
        volume_source_folder: /tmp/vault/
        volume_destination_folder: /vault/config
        volume_mode: "0777"

    # Delete temp folder
    - name: Delete temporary folder...
      ansible.builtin.file:
        path: /tmp/vault
        state: absent

    #####################################################
    ## Firewall configuration                          ##
    #####################################################

    # Open firewall ports
    - name: Open firewall ports...
      become: true
      ansible.posix.firewalld:
        port: "{{ (item.split(':')[0]) }}/tcp"
        permanent: true
        state: enabled
        immediate: true
      loop: "{{ openbao_container_ports | default([]) }}"

    #####################################################
    ## Import container                                ##
    #####################################################

    # Import container
    - name: Install {{ openbao_container_name }} container on podman
      ansible.builtin.include_role:
        name: podman
      vars:
        action_type: import_container
        container_repository_url: "{{ openbao_container_repository_url }}"
        container_repository_tag: "{{ openbao_container_repository_tag | default(omit) }}"
        container_repository_checksum: "{{ openbao_container_repository_checksum | default(omit) }}"
        container_repository_checksum_algorithm: "{{ openbao_container_repository_checksum_algorithm | default(omit) }}"
        container_name: "{{ openbao_container_name }}"
        container_ports: "{{ openbao_container_ports }}"
        container_volumes: "{{ openbao_container_volumes }}"
        container_command: vault server -config=/vault/config/vault.hcl
        container_security_opt: [label=disable]
        container_env: "{{ openbao_container_environment | default(omit) }}"
        container_privileged: "{{ openbao_container_privileged | default(false) }}"
        container_cap_add: "{{ openbao_container_cap_add | default(omit) }}"
        container_cap_drop: "{{ openbao_container_cap_drop | default(omit) }}"
        container_user: "{{ openbao_container_user | default(omit) }}"
        container_healthcheck: "{{ openbao_container_healthcheck | default(omit) }}"
        container_healthcheck_fail: "{{ openbao_container_healthcheck_fail | default('none') }}"
        container_healthcheck_retries: "{{ openbao_container_healthcheck_retries | default(omit) }}"
        container_healthcheck_interval: "{{ openbao_container_healthcheck_interval | default(omit) }}"
        container_healthcheck_timeout: "{{ openbao_container_healthcheck_timeout | default(omit) }}"
        container_healthcheck_start: "{{ openbao_container_healthcheck_start | default(omit) }}"

#########################################################
## Configuration                                       ##
#########################################################

# Get ip address
- name: Register variable (vault_address)...
  ansible.builtin.set_fact:
    vault_address: https://{{ ansible_default_ipv4.address }}:{{ openbao_container_ports[0].split(':')[0] }}

# Configure OpenBao
- name: Configure application
  ansible.builtin.include_tasks: configure.yml

#########################################################
## Post-install                                        ##
#########################################################

# Unset variables
#- name: Unset variables...
#  ansible.builtin.set_fact:
